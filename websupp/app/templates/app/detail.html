{% extends 'app/base.html' %}
{% load custom_filters %}
{% block content %}
{% if request.GET.added == 'true' %}
<div 
    x-data="{ show: true }" 
    x-init="setTimeout(() => show = false, 3000)" 
    x-show="show"
    x-transition
    class="fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50"
>
    ‚úÖ S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!
</div>
{% endif %}
<div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-10 py-12 px-4">
    <!-- ·∫¢nh s·∫£n ph·∫©m -->
    <div class="flex flex-col items-center">
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-72 h-72 object-contain rounded-xl shadow-lg mb-4 bg-white">
    </div>
    <!-- Th√¥ng tin v√† form mua -->
    <div class="flex flex-col justify-center">
        <h1 class="text-3xl font-extrabold mb-3 text-gray-900 dark:text-white">{{ product.name }}</h1>
        <div class="text-2xl font-bold text-red-500 mb-4">Gi√°: {{ product.price|floatformat:0 }}‚Ç´</div>
        <form action="{% url 'cart_add' product.id %}" method="post" class="space-y-4">
            {% csrf_token %}
            {% if product.weight_options %}
            <div>
                <label class="font-semibold">Ch·ªçn kh·ªëi l∆∞·ª£ng:</label>
                <select name="weight" class="w-full px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black">
                {% for weight in product.weight_options|split_by:"," %}
                  <option value="{{ weight|trim }}">{{ weight }}</option>
                {% endfor %}
                </select>
            </div>
            {% endif %}
            {% if product.flavor_options %}
            <div>
                <label class="font-semibold">Ch·ªçn h∆∞∆°ng v·ªã:</label>
                <select name="flavor" class="w-full px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black">
                {% for flavor in product.flavor_options|split_by:"," %}
                  <option value="{{ flavor|trim }}">{{ flavor }}</option>
                {% endfor %}
                </select>
            </div>
            {% endif %}
            <div>
                <label class="font-semibold">S·ªë l∆∞·ª£ng:</label>
                <input type="number" name="quantity" value="1" min="1"
       class="w-24 px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black">
            </div>
            <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg text-lg flex justify-center items-center gap-2">
                <span>üõí</span> Th√™m v√†o gi·ªè
            </button>
        </form>
        <div x-data="{ open: false }" class="mt-8">
            <button @click="open = !open"
                    class="font-bold mb-2 text-lg focus:outline-none flex items-center gap-2">
                M√¥ t·∫£ s·∫£n ph·∫©m:
                <svg :class="{'rotate-90': open}" class="w-4 h-4 transform transition-transform" fill="none"
                     stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
            <div x-show="open" class="text-gray-200 dark:text-gray-300 mt-2 pl-3" x-transition>
                {{ product.description }}
            </div>
        </div>
    </div>
</div>

<!-- Tabs m√¥ t·∫£ & ƒë√°nh gi√° s·∫£n ph·∫©m -->
<div x-data="{ tab: 1 }" class="max-w-3xl mx-auto mt-12 bg-white dark:bg-gray-900 rounded-xl shadow px-6 py-8">
    <div class="border-b flex gap-12 text-lg font-bold uppercase mb-6">
        <button @click="tab = 1"
            :class="tab === 1 ? 'text-red-500 border-b-2 border-red-500' : 'text-gray-400 border-b-2 border-transparent'"
            class="pb-2 focus:outline-none transition">M√¥ t·∫£ s·∫£n ph·∫©m</button>
        <button @click="tab = 2"
            :class="tab === 2 ? 'text-red-500 border-b-2 border-red-500' : 'text-gray-400 border-b-2 border-transparent'"
            class="pb-2 focus:outline-none transition">ƒê√°nh gi√° ({{ reviews|length }})</button>
    </div>
    <!-- Tab m√¥ t·∫£ -->
    <div x-show="tab === 1" x-transition>
        <div class="text-gray-700 dark:text-gray-200 leading-relaxed">
            {{ product.description|linebreaks }}
        </div>
    </div>
    <!-- Tab ƒë√°nh gi√° -->
    <div x-show="tab === 2" x-transition>
        {% if reviews %}
            {% for review in reviews %}
                <div class="border-b py-2">
                    <div class="font-bold">{{ review.name }}</div>
                    <div class="text-yellow-400">
                        {% for _ in "12345"|slice:":review.rating"|make_list %}‚òÖ{% endfor %}
                        {% for _ in "12345"|slice:"review.rating:"|make_list %}<span class="text-gray-400">‚òÖ</span>{% endfor %}
                    </div>
                    <div>{{ review.content }}</div>
                    <div class="text-xs text-gray-500">{{ review.created_at|date:"d/m/Y H:i" }}</div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-gray-400 italic">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n nh·∫≠n x√©t!</div>
        {% endif %}
        <!-- Form ƒë√°nh gi√° m·ªõi -->
        <form method="post" class="mt-6 space-y-3">
            {% csrf_token %}
            <input type="hidden" name="review_submit" value="1">
            <div>
                <label class="font-semibold">T√™n c·ªßa b·∫°n *</label>
                <input type="text" name="name" required class="w-full px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black">
            </div>
            <div>
                <label class="font-semibold">ƒê√°nh gi√° *</label>
                <select name="rating" required class="w-32 px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black">
                    {% for i in "54321" %}
                        <option value="{{ i }}">{{ i }} ‚òÖ</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="font-semibold">N·ªôi dung ƒë√°nh gi√° *</label>
                <textarea name="content" rows="4" required class="w-full px-3 py-2 rounded border border-gray-300 mt-1 bg-white text-black"></textarea>
            </div>
            <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg text-lg flex justify-center items-center gap-2">
                <span>‚≠ê</span> G·ª≠i ƒë√°nh gi√°
            </button>
            {% if message %}
            <div class="text-red-500 font-bold">{{ message }}</div>
            {% endif %}
        </form>
    </div>
</div>

{% endblock %}
